package api.listings;

import java.util.HashMap;

import org.json.JSONArray;
import org.json.JSONObject;

import helpers.HTTPHelper;
import helpers.Meta;
import api.Comment;
import api.Submission;

public class Listing {
	private static HTTPHelper http = new HTTPHelper();
	
	public static Comment[] getCommentsFromPost(Submission post, String sort, int context, Comment comment, int depth, int limit) {
		HashMap<String, String> params = new HashMap<String, String>();
		params.put("article", post.getId());
		params.put("context", "" + context);
		params.put("sort", sort);
		params.put("depth", "" + depth);
		params.put("limit", "" + limit);
		if(comment != null) {
			params.put("comment", comment.getId());
		}
		HashMap<String, String> headers = new HashMap<String, String>();
		headers.put("User-Agent", Meta.getUserAgent());
		
		JSONObject json = http.makeGetRequest("/r/" + post.getSubredditName() + "/comments/.json", params, headers);
		int numTopLevel = 0;
		JSONArray comments = (JSONArray)((JSONObject)json.get("data")).get("children");
		HashMap<String, Comment> commentList = new HashMap<String, Comment>();
		for(int i = 0; i < comments.length(); i++) {
			JSONObject data = comments.getJSONObject(i).getJSONObject("data");
			boolean isTopLevel = data.getString("link_id").equals(data.getString("parent_id"));
			if(isTopLevel) {
				numTopLevel++;
			}
			commentList.put(data.getString("name"), new Comment(data, isTopLevel));
		}
		
		for(int i = 0; i < comments.length(); i++) {
			JSONObject data = comments.getJSONObject(i).getJSONObject("data");
			if(commentList.get(data.getString("parent_id")) != null) {
				commentList.get(data.getString("parent_id")).addChild(commentList.get(data.getString("name")));
				
			}
		}
		
		Comment[] commentArray = new Comment[numTopLevel];
		int index = 0;
		
		for(String key : commentList.keySet()) {
			if(commentList.get(key).isTopLevel()) {
				commentArray[index++] = commentList.get(key);
			}
		}
		
		return commentArray;
	}
	
}
